<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>O Perfumista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --gold:#d4af37;
  --bg:#0b0b0c;
  --card:#111;
  --text:#fff;
  --muted:#aaa;
  --radius:16px;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
.container{
  max-width:900px;
  margin:auto;
  padding:28px 18px;
}
h1{
  text-align:center;
  color:var(--gold);
  letter-spacing:3px;
}
.card{
  background:#111;
  border:1px solid rgba(212,175,55,.35);
  border-radius:18px;
  padding:20px;
}
#status{
  color:var(--muted);
  margin-bottom:10px;
}
.rec{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}
.rec b{
  color:var(--gold);
}
textarea{
  width:100%;
  min-height:120px;
  background:#000;
  border:1px solid rgba(255,255,255,.2);
  border-radius:12px;
  color:white;
  padding:12px;
  margin-top:10px;
}
button{
  margin-top:10px;
  padding:12px 16px;
  border:none;
  border-radius:12px;
  background:var(--gold);
  color:#000;
  font-weight:700;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="container">
  <h1>O PERFUMISTA</h1>

  <div class="card">
    <div id="status">Pronto.</div>
    <div id="respostas"></div>

    <textarea id="prompt" placeholder="Quer pedir outra recomendação?"></textarea>
    <button id="sendBtn">Gerar sugestões</button>
  </div>
</div>

<script>
const API_URL = "https://operfumista-api.vercel.app/api/perfumista";
const MAPA_ORIGIN = "https://vguerise.github.io";

let contextoMapa = "";

const statusEl = document.getElementById("status");
const respostasEl = document.getElementById("respostas");
const promptEl = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");

function setStatus(txt){
  statusEl.textContent = txt;
  enviarAltura();
}

function enviarAltura(){
  if(window.parent !== window){
    const h = document.body.scrollHeight;
    window.parent.postMessage(
      { source:"operfumista", type:"height", height:h },
      MAPA_ORIGIN
    );
  }
}

async function chamarAPI(texto){
  setStatus("Consultando o Perfumista…");
  sendBtn.disabled = true;

  try{
    const resp = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({
        diagnostico: texto,
        prompt: texto
      })
    });

    const data = await resp.json();

    if(!resp.ok){
      throw new Error(data?.error || "HTTP " + resp.status);
    }

    renderizar(data);
    setStatus("Pronto.");

  }catch(err){
    respostasEl.innerHTML = `<div class="rec">Erro: ${err.message}</div>`;
    setStatus("Erro.");
  }

  sendBtn.disabled = false;
  enviarAltura();
}

function renderizar(data){
  respostasEl.innerHTML = "";

  if(Array.isArray(data.recomendacoes)){
    data.recomendacoes.forEach(r=>{
      const div = document.createElement("div");
      div.className="rec";
      div.innerHTML = `
        <b>${r.nome || "Perfume"}</b><br>
        ${r.por_que || ""}
      `;
      respostasEl.appendChild(div);
    });
  }else{
    respostasEl.innerHTML = `<div class="rec">${JSON.stringify(data)}</div>`;
  }
}

sendBtn.onclick = ()=>{
  const t = promptEl.value.trim();
  if(!t) return;
  const final = contextoMapa ? contextoMapa + "\n\n" + t : t;
  chamarAPI(final);
  promptEl.value="";
};

window.addEventListener("message", e=>{
  if(e.origin !== MAPA_ORIGIN) return;

  if(e.data?.source==="mapa" && e.data.type==="set_and_run"){
    contextoMapa = e.data.text || "";
    if(contextoMapa) chamarAPI(contextoMapa);
  }
});

window.onload = enviarAltura;
</script>
</body>
</html>
