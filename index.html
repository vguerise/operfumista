<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>O Perfumista</title>
  <style>
    :root{
      --bg:#121212;
      --panel: rgba(0,0,0,.35);
      --border: rgba(212,175,55,.25);
      --gold:#d4af37;
      --gold2:#f4e5b1;
      --text:#f2f2f2;
      --muted:#b9b9b9;
      --danger:#ff6b6b;
      --blue: rgba(155,196,255,.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(212,175,55,.10), transparent 60%),
                  linear-gradient(135deg, #2b2b2b 0%, #121212 60%);
      color: var(--text);
    }
    .wrap{ max-width: 1020px; margin: 0 auto; padding: 22px 16px 28px; }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .top{ display:flex; align-items:center; gap:14px; margin-bottom: 12px; }
    .badge{
      width:44px;height:44px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 100%);
      color:#111;font-weight:900;
      box-shadow: 0 12px 30px rgba(212,175,55,.25);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size: 1.25rem; letter-spacing:.2px; }
    .sub{ margin:4px 0 0; color: var(--muted); font-size:.92rem; line-height:1.35; }
    .status{ margin: 10px 0 0; color: var(--muted); font-size: .92rem; min-height: 22px; }

    .resultHeader{
      margin-top: 14px;
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(212,175,55,.08);
      border-radius: 16px;
      padding: 12px 14px;
      display:none;
    }
    .resultHeader .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
      color: var(--gold2);
      margin:0 0 4px;
    }
    .resultHeader .desc{
      margin:0;
      color: rgba(242,242,242,.75);
      font-size: .92rem;
    }

    .cards{ margin-top: 14px; display:flex; flex-direction:column; gap:12px; }
    .recCard{
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.28);
      border-radius: 16px;
      padding: 14px;
    }
    .recTop{ display:flex; gap:12px; align-items:flex-start; }
    .num{
      width:38px;height:38px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(212,175,55,.16);
      border: 1px solid rgba(212,175,55,.35);
      color: var(--gold2);
      font-weight:900;
      flex:0 0 auto;
    }
    .recName{ margin:0; font-size: 1.05rem; font-weight:900; color: var(--gold2); line-height: 1.2; }
    .meta{ margin: 8px 0 0; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(242,242,242,.92);
      font-size: .92rem;
      white-space: nowrap;
    }
    .pill b{ color: var(--blue); }

    .body{
      margin-top: 12px;
      color: rgba(242,242,242,.92);
      line-height:1.5;
    }
    .kv{ margin: 8px 0 0; }
    .kv .k{ color: rgba(242,242,242,.70); font-weight:900; }
    .kv .v{ color: rgba(242,242,242,.92); }
    .kv p{ margin: 6px 0; }

    .err{
      margin-top: 10px;
      color: var(--danger);
      font-weight:800;
      white-space: pre-wrap;
      display:none;
    }

    .ask{
      margin-top: 18px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 14px;
    }
    .askHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .askTitle{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      font-size: 1rem;
      color: var(--gold2);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .askHint{
      margin:0;
      color: rgba(242,242,242,.72);
      font-size: .92rem;
      line-height: 1.35;
    }

    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      background: rgba(0,0,0,.35);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
      font-size: 1rem;
      outline: none;
    }
    textarea:focus{
      border-color: rgba(212,175,55,.55);
      box-shadow: 0 0 0 3px rgba(212,175,55,.12);
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      appearance:none; border:0; border-radius: 12px;
      padding: 12px 16px;
      font-weight:900; cursor:pointer;
      transition: transform .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 100%);
      color:#111;
      box-shadow: 0 12px 30px rgba(212,175,55,.25);
    }
    .btn-ghost{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="badge">ü§ñ</div>
        <div>
          <h1>O Perfumista</h1>
          <p class="sub">Recomenda√ß√µes em cards. Depois, pe√ßa mais sugest√µes no campo em branco.</p>
        </div>
      </div>

      <div id="status" class="status">Pronto.</div>

      <div id="resultHeader" class="resultHeader">
        <div class="title">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
        <p class="desc" id="resultSub">Baseado no seu contexto e lacunas identificadas.</p>
      </div>

      <div id="cards" class="cards"></div>
      <div id="err" class="err"></div>

      <div class="ask">
        <div class="askHeader">
          <p class="askTitle">‚úçÔ∏è Quer mais alguma sugest√£o?</p>
          <button class="btn btn-ghost" id="clearBtn">Limpar</button>
        </div>
        <p class="askHint">Digite a situa√ß√£o, clima, ambiente e or√ßamento. Ex.: ‚ÄúNoite, clima quente, evento casual, at√© R$600; quero algo amadeirado sem doce‚Äù.</p>

        <textarea
          id="prompt"
          placeholder="Quer mais alguma sugest√£o? Digite a situa√ß√£o, clima, ambiente e or√ßamento!"
        ></textarea>

        <div class="row">
          <button class="btn btn-primary" id="sendBtn">‚ú® Gerar sugest√µes</button>
          <button class="btn btn-ghost" id="useContextBtn" title="Usa o diagn√≥stico do mapa junto do que voc√™ escreveu">
            ‚ûï Usar diagn√≥stico do Mapa
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ENDPOINT_URL = "https://operfumista-api.vercel.app/api/perfumista";
    const MAPA_ALLOWED_ORIGIN = "https://vguerise.github.io";

    // ===== STATE =====
    let DIAG_CONTEXT = ""; // fica escondido (n√£o aparece na tela)
    let useContext = true; // bot√£o ‚ÄúUsar diagn√≥stico do Mapa‚Äù liga/desliga

    // ===== postMessage helper =====
    function notifyParent(type, payload = {}) {
      if (window.parent === window) return;
      try {
        window.parent.postMessage({ source: "operfumista", type, ...payload }, MAPA_ALLOWED_ORIGIN);
      } catch (e) {}
    }

    // ===== auto height to parent =====
    let _heightTicking = false;
    function sendHeightToParent() {
      if (_heightTicking) return;
      _heightTicking = true;
      requestAnimationFrame(() => {
        _heightTicking = false;
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        notifyParent("height", { height: h });
      });
    }
    window.addEventListener("load", () => {
      sendHeightToParent();
      setTimeout(sendHeightToParent, 250);
      setTimeout(sendHeightToParent, 650);
    });
    try {
      const ro = new ResizeObserver(() => sendHeightToParent());
      ro.observe(document.body);
    } catch (e) {
      setInterval(sendHeightToParent, 900);
    }

    // ===== UI refs =====
    const statusEl = document.getElementById("status");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const useContextBtn = document.getElementById("useContextBtn");

    const cardsEl = document.getElementById("cards");
    const headerEl = document.getElementById("resultHeader");
    const headerSubEl = document.getElementById("resultSub");
    const errEl = document.getElementById("err");

    function setStatus(t) { statusEl.textContent = t; sendHeightToParent(); }
    function showError(msg) { errEl.style.display="block"; errEl.textContent = msg; sendHeightToParent(); }
    function clearError(){ errEl.style.display="none"; errEl.textContent=""; sendHeightToParent(); }

    clearBtn.addEventListener("click", () => {
      promptEl.value = "";
      clearError();
      sendHeightToParent();
      promptEl.focus();
    });

    useContextBtn.addEventListener("click", () => {
      useContext = !useContext;
      useContextBtn.textContent = useContext ? "‚ûï Usar diagn√≥stico do Mapa" : "‚õî Sem diagn√≥stico do Mapa";
      setStatus(useContext ? "Ok ‚Äî vou usar o diagn√≥stico do Mapa como contexto." : "Ok ‚Äî vou ignorar o diagn√≥stico do Mapa.");
    });

    // ===== Helpers =====
    function cleanMarkdown(s){
      return String(s || "")
        .replaceAll("**","")
        .replaceAll("__","")
        .replaceAll("`","")
        .trim();
    }

    function pickField(lines, keyRegex){
      for (const l of lines){
        const m = l.match(keyRegex);
        if (m) return cleanMarkdown(m[1] || m[2] || "").trim();
      }
      return "";
    }

    function splitRecommendations(raw){
      // captura blocos come√ßando com "1." ou "1)" no in√≠cio de linha
      const text = String(raw || "");
      const blocks = text.split(/\n\s*(?=\d+\s*[\.\)]\s+)/g).map(s=>s.trim()).filter(Boolean);
      const items = blocks.filter(b => /^\d+\s*[\.\)]\s+/.test(b)).slice(0,3);
      return items;
    }

    function parseBlock(block){
      // remove "1." do in√≠cio
      const firstLineMatch = block.match(/^(\d+)\s*[\.\)]\s*([\s\S]*)$/);
      const n = firstLineMatch ? Number(firstLineMatch[1]) : 1;
      const content = firstLineMatch ? firstLineMatch[2].trim() : block.trim();

      const lines = content.split("\n").map(l=>l.trim()).filter(Boolean);

      // Nome costuma estar na primeira linha (√†s vezes com **)
      let name = cleanMarkdown(lines[0] || `Recomenda√ß√£o ${n}`);

      // Campos
      const familia = pickField(lines, /^fam[i√≠]lia\s*:\s*(.+)$/i);
      const faixa   = pickField(lines, /^(faixa|pre[√ßc]o|or[√ßc]amento)\s*:\s*(.+)$/i) || pickField(lines, /^(?:faixa)\s*:\s*(.+)$/i);
      const quando  = pickField(lines, /^quando\s+usar\s*:\s*(.+)$/i);
      const porque  = pickField(lines, /^(por\s+que\s+combina|por\s+qu√™\s+combina|por\s+que|por\s+qu√™)\s*:\s*(.+)$/i);

      // fallback: tenta achar ‚ÄúFaixa: ‚Ä¶‚Äù mesmo se o regex pegou grupo errado
      const faixa2 = faixa && faixa.startsWith("Faixa") ? faixa.replace(/^Faixa\s*:\s*/i,"") : faixa;

      return { n, name, familia, faixa: faixa2, quando, porque };
    }

    function parseResponse(raw){
      const text = String(raw || "").trim();
      if (!text) return null;

      const blocks = splitRecommendations(text);

      // Se n√£o vier formatado como 1./2./3., cai no modo ‚Äú1 card‚Äù
      if (!blocks.length){
        return {
          title: "3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO",
          items: [{ n: 1, name: "Sugest√µes", familia:"", faixa:"", quando:"", porque: cleanMarkdown(text) }]
        };
      }

      const items = blocks.map(parseBlock);

      return { title: "3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO", items };
    }

    function render(parsed){
      cardsEl.innerHTML = "";
      headerEl.style.display = "block";
      headerSubEl.textContent = "Baseado no seu contexto e lacunas identificadas.";

      const frag = document.createDocumentFragment();

      parsed.items.forEach(it => {
        const card = document.createElement("div");
        card.className = "recCard";
        card.innerHTML = `
          <div class="recTop">
            <div class="num">${it.n}</div>
            <div style="flex:1">
              <h3 class="recName">${it.name}</h3>
              <div class="meta">
                ${it.familia ? `<span class="pill">üåø <b>Fam√≠lia:</b> ${it.familia}</span>` : `<span class="pill">‚úÖ Recomenda√ß√£o</span>`}
                ${it.faixa ? `<span class="pill">üí∞ <b>Faixa:</b> ${it.faixa}</span>` : ``}
              </div>
            </div>
          </div>

          <div class="body">
            <div class="kv">
              ${it.quando ? `<p><span class="k">Quando usar:</span> <span class="v">${it.quando}</span></p>` : ``}
              ${it.porque ? `<p><span class="k">Por que combina:</span> <span class="v">${it.porque}</span></p>` : ``}
            </div>
          </div>
        `;
        frag.appendChild(card);
      });

      cardsEl.appendChild(frag);
      sendHeightToParent();
    }

    async function callApi(finalPrompt) {
      clearError();
      setStatus("Consultando o Perfumista‚Ä¶");
      notifyParent("loading", { value: true });

      try {
        sendBtn.disabled = true;

        const r = await fetch(ENDPOINT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: finalPrompt })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data?.error ? String(data.error) : ("HTTP " + r.status));

        const text = (data?.text || "").trim();
        if (!text) throw new Error("Resposta vazia da API.");

        const parsed = parseResponse(text);
        render(parsed);

        setStatus("Pronto.");
        notifyParent("done", { value: true });

      } catch (e) {
        showError("Erro ao consultar o agente: " + String(e?.message || e));
        setStatus("Erro.");
        notifyParent("error", { message: String(e?.message || e) });

      } finally {
        sendBtn.disabled = false;
        notifyParent("loading", { value: false });
        sendHeightToParent();
      }
    }

    // clique "Gerar sugest√µes"
    sendBtn.addEventListener("click", async () => {
      const userText = (promptEl.value || "").trim();

      let finalPrompt = "";
      if (!userText && DIAG_CONTEXT && useContext) {
        finalPrompt = DIAG_CONTEXT;
      } else if (userText && DIAG_CONTEXT && useContext) {
        finalPrompt =
          "DIAGN√ìSTICO (contexto):\n" + DIAG_CONTEXT +
          "\n\nPEDIDO (agora):\n" + userText;
      } else {
        finalPrompt = userText;
      }

      if (!finalPrompt.trim()) {
        setStatus("Digite sua situa√ß√£o ou use um diagn√≥stico do Mapa.");
        promptEl.focus();
        return;
      }

      await callApi(finalPrompt);

      // sempre volta em branco (pra incentivar pedir mais)
      promptEl.value = "";
      sendHeightToParent();
    });

    // ===== Receber do Mapa via iframe =====
    window.addEventListener("message", async (event) => {
      if (event.origin !== MAPA_ALLOWED_ORIGIN) return;

      const data = event.data || {};
      if (data.source !== "mapa" || data.type !== "set_and_run") return;

      const texto = (data.text || "").trim();
      if (!texto) return;

      // guarda contexto (invis√≠vel) e roda
      DIAG_CONTEXT = texto;
      await callApi(texto);

      // textarea sempre em branco
      promptEl.value = "";
      sendHeightToParent();
    });
  </script>
</body>
</html>
