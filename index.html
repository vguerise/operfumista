<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>O Perfumista</title>
  <style>
    :root{
      --bg:#121212;
      --panel: rgba(0,0,0,.35);
      --panel2: rgba(0,0,0,.22);
      --border: rgba(212,175,55,.25);
      --gold:#d4af37;
      --gold2:#f4e5b1;
      --text:#f2f2f2;
      --muted:#b9b9b9;
      --danger:#ff6b6b;
      --blue: rgba(155,196,255,.95);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 50% 10%, rgba(212,175,55,.10), transparent 60%),
                  linear-gradient(135deg, #2b2b2b 0%, #121212 60%);
      color: var(--text);
    }
    .wrap{
      max-width: 1020px;
      margin: 0 auto;
      padding: 22px 16px 28px;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
    }
    .top{ display:flex; align-items:center; gap:14px; margin-bottom: 12px; }
    .badge{
      width:44px;height:44px;border-radius:12px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 100%);
      color:#111;font-weight:900;
      box-shadow: 0 12px 30px rgba(212,175,55,.25);
      flex:0 0 auto;
    }
    h1{ margin:0; font-size: 1.25rem; letter-spacing:.2px; }
    .sub{ margin:4px 0 0; color: var(--muted); font-size:.92rem; line-height:1.35; }
    .status{ margin: 10px 0 0; color: var(--muted); font-size: .92rem; min-height: 22px; }

    /* diagn√≥stico recebido do mapa (opcional, mas ajuda contexto sem ‚Äúsujar‚Äù a caixa de digita√ß√£o) */
    .contextBox{
      margin-top: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 16px;
      padding: 12px 14px;
      display:none;
    }
    .contextTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .contextTitle{
      margin:0;
      font-weight:900;
      color: rgba(242,242,242,.90);
      letter-spacing:.2px;
      font-size:.95rem;
    }
    .miniBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }
    .contextText{
      margin:0;
      color: rgba(242,242,242,.78);
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 180px;
      overflow:auto;
      border-radius: 12px;
      padding: 10px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
    }

    /* ===== RESULT HEADER ===== */
    .resultHeader{
      margin-top: 14px;
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(212,175,55,.08);
      border-radius: 16px;
      padding: 12px 14px;
      display:none;
    }
    .resultHeader .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.2px;
      color: var(--gold2);
      margin:0 0 4px;
    }
    .resultHeader .desc{
      margin:0;
      color: rgba(242,242,242,.75);
      font-size: .92rem;
    }

    /* ===== CARDS ===== */
    .cards{ margin-top: 14px; display:flex; flex-direction:column; gap:12px; }
    .recCard{
      border: 1px solid rgba(212,175,55,.22);
      background: rgba(0,0,0,.28);
      border-radius: 16px;
      padding: 14px;
    }
    .recTop{ display:flex; gap:12px; align-items:flex-start; }
    .num{
      width:38px;height:38px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(212,175,55,.16);
      border: 1px solid rgba(212,175,55,.35);
      color: var(--gold2);
      font-weight:900;
      flex:0 0 auto;
    }
    .recName{ margin:0; font-size: 1.05rem; font-weight:900; color: var(--gold2); line-height: 1.2; }
    .meta{ margin: 6px 0 0; color: var(--blue); font-size: .95rem; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px; border-radius: 999px;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(242,242,242,.90);
      font-size: .92rem;
    }

    /* corpo com formata√ß√£o melhor */
    .body{
      margin-top: 10px;
      color: rgba(242,242,242,.92);
      line-height:1.5;
      white-space: normal;
    }
    .body p{ margin: 0 0 10px; }
    .body ul{ margin: 6px 0 10px 18px; padding:0; }
    .body li{ margin: 4px 0; }
    .body b, .body strong{ color: rgba(242,242,242,.98); }
    .body .k{ color: rgba(242,242,242,.70); font-weight:800; }

    .err{
      margin-top: 10px;
      color: var(--danger);
      font-weight:800;
      white-space: pre-wrap;
      display:none;
    }

    /* ===== ASK AREA ===== */
    .ask{
      margin-top: 18px;
      border-top: 1px solid rgba(255,255,255,.10);
      padding-top: 14px;
    }
    .askHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .askTitle{
      margin:0;
      font-weight:900;
      letter-spacing:.2px;
      font-size: 1rem;
      color: var(--gold2);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .askHint{
      margin:0;
      color: rgba(242,242,242,.72);
      font-size: .92rem;
      line-height: 1.35;
    }

    textarea{
      width:100%;
      min-height: 110px;
      resize: vertical;
      background: rgba(0,0,0,.35);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 14px;
      font-size: 1rem;
      outline: none;
    }
    textarea:focus{
      border-color: rgba(212,175,55,.55);
      box-shadow: 0 0 0 3px rgba(212,175,55,.12);
    }
    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top: 10px; }
    .btn{
      appearance:none; border:0; border-radius: 12px;
      padding: 12px 16px;
      font-weight:900; cursor:pointer;
      transition: transform .15s ease, opacity .15s ease;
      display:inline-flex; align-items:center; gap:10px;
      user-select:none; white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold2) 100%);
      color:#111;
      box-shadow: 0 12px 30px rgba(212,175,55,.25);
    }
    .btn-ghost{
      background: rgba(255,255,255,.08);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="badge">ü§ñ</div>
        <div>
          <h1>O Perfumista</h1>
          <p class="sub">Sugest√µes em cards, sem ‚Äútexto cru‚Äù. Voc√™ pode pedir mais sugest√µes no final.</p>
        </div>
      </div>

      <div id="status" class="status">Pronto.</div>

      <!-- CONTEXTO RECEBIDO DO MAPA (N√ÉO VAI PARA A CAIXA DE DIGITA√á√ÉO) -->
      <div id="contextBox" class="contextBox">
        <div class="contextTop">
          <p class="contextTitle">üìå Diagn√≥stico recebido do Mapa (usado como contexto)</p>
          <button class="miniBtn" id="toggleContextBtn">Ocultar</button>
        </div>
        <pre id="contextText" class="contextText"></pre>
      </div>

      <!-- RESULTADOS -->
      <div id="resultHeader" class="resultHeader">
        <div class="title">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
        <p class="desc" id="resultSub">Baseado no seu diagn√≥stico e lacunas identificadas.</p>
      </div>

      <div id="cards" class="cards"></div>

      <div id="err" class="err"></div>

      <!-- PERGUNTA SEMPRE EM BRANCO -->
      <div class="ask">
        <div class="askHeader">
          <p class="askTitle">‚úçÔ∏è Quer mais alguma sugest√£o?</p>
          <button class="miniBtn" id="clearBtn">Limpar</button>
        </div>
        <p class="askHint">Digite a situa√ß√£o, clima, ambiente e or√ßamento. Ex.: ‚ÄúNoite, clima quente, evento casual, at√© R$600; quero algo amadeirado sem doce‚Äù.</p>

        <textarea
          id="prompt"
          placeholder="Quer mais alguma sugest√£o? Digite a situa√ß√£o, clima, ambiente e or√ßamento!"
        ></textarea>

        <div class="row">
          <button class="btn btn-primary" id="sendBtn">‚ú® Gerar sugest√µes</button>
          <button class="btn btn-ghost" id="useContextBtn" title="Usa o diagn√≥stico do mapa junto do que voc√™ escreveu">
            ‚ûï Usar diagn√≥stico do Mapa
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const ENDPOINT_URL = "https://operfumista-api.vercel.app/api/perfumista";
    const MAPA_ALLOWED_ORIGIN = "https://vguerise.github.io";

    // ===== postMessage helper =====
    function notifyParent(type, payload = {}) {
      if (window.parent === window) return;
      try {
        window.parent.postMessage({ source: "operfumista", type, ...payload }, MAPA_ALLOWED_ORIGIN);
      } catch (e) {}
    }

    // ===== auto height to parent =====
    let _heightTicking = false;
    function sendHeightToParent() {
      if (_heightTicking) return;
      _heightTicking = true;
      requestAnimationFrame(() => {
        _heightTicking = false;
        const h = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
        notifyParent("height", { height: h });
      });
    }
    window.addEventListener("load", () => {
      sendHeightToParent();
      setTimeout(sendHeightToParent, 250);
      setTimeout(sendHeightToParent, 650);
    });
    try {
      const ro = new ResizeObserver(() => sendHeightToParent());
      ro.observe(document.body);
    } catch (e) {
      setInterval(sendHeightToParent, 900);
    }

    // ===== UI refs =====
    const statusEl = document.getElementById("status");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const useContextBtn = document.getElementById("useContextBtn");

    const cardsEl = document.getElementById("cards");
    const headerEl = document.getElementById("resultHeader");
    const headerSubEl = document.getElementById("resultSub");
    const errEl = document.getElementById("err");

    const contextBox = document.getElementById("contextBox");
    const contextText = document.getElementById("contextText");
    const toggleContextBtn = document.getElementById("toggleContextBtn");

    // ===== State =====
    let DIAG_CONTEXT = ""; // diagn√≥stico vindo do mapa
    let contextVisible = true;

    function setStatus(t) { statusEl.textContent = t; sendHeightToParent(); }
    function showError(msg) { errEl.style.display="block"; errEl.textContent = msg; sendHeightToParent(); }
    function clearError(){ errEl.style.display="none"; errEl.textContent=""; sendHeightToParent(); }

    function showContextBox(text){
      DIAG_CONTEXT = text || "";
      if (!DIAG_CONTEXT) { contextBox.style.display = "none"; return; }
      contextBox.style.display = "block";
      contextText.textContent = DIAG_CONTEXT;
      toggleContextBtn.textContent = contextVisible ? "Ocultar" : "Mostrar";
      contextText.style.display = contextVisible ? "block" : "none";
      sendHeightToParent();
    }

    toggleContextBtn.addEventListener("click", () => {
      contextVisible = !contextVisible;
      contextText.style.display = contextVisible ? "block" : "none";
      toggleContextBtn.textContent = contextVisible ? "Ocultar" : "Mostrar";
      sendHeightToParent();
    });

    clearBtn.addEventListener("click", () => {
      promptEl.value = "";
      clearError();
      sendHeightToParent();
      promptEl.focus();
    });

    useContextBtn.addEventListener("click", () => {
      if (!DIAG_CONTEXT) {
        setStatus("Ainda n√£o recebi um diagn√≥stico do Mapa.");
        return;
      }
      setStatus("Ok ‚Äî vou usar o diagn√≥stico do Mapa junto do que voc√™ escreveu.");
    });

    // ===== Helpers de formata√ß√£o (transforma texto em HTML bonito) =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function beautifyBody(text){
      // converte linhas com "- " ou "‚Ä¢ " em lista
      const lines = String(text || "").split("\n");
      const out = [];
      let list = [];

      function flushList(){
        if (list.length){
          out.push("<ul>" + list.map(li => "<li>" + escapeHtml(li) + "</li>").join("") + "</ul>");
          list = [];
        }
      }

      for (const raw of lines){
        const l = raw.trim();
        if (!l){ flushList(); continue; }

        const bullet = l.match(/^[-‚Ä¢]\s+(.*)$/);
        if (bullet){
          list.push(bullet[1]);
          continue;
        }

        flushList();

        // destaca "Quando usar:" "Por qu√™:" etc
        const keyMatch = l.match(/^(Quando usar|Por qu√™|Por que|Fam√≠lia|Pre√ßo|Or√ßamento|Clima|Ambiente)\s*:\s*(.*)$/i);
        if (keyMatch){
          out.push(`<p><span class="k">${escapeHtml(keyMatch[1])}:</span> ${escapeHtml(keyMatch[2])}</p>`);
        } else {
          out.push("<p>" + escapeHtml(l) + "</p>");
        }
      }
      flushList();
      return out.join("");
    }

    // ===== Parser em 3 cards =====
    function parseToCards(text) {
      const raw = (text || "").trim();
      if (!raw) return null;

      const parts = raw.split(/\n\s*(?=\d\)\s+)/).map(s => s.trim()).filter(Boolean);
      const items = parts.filter(p => /^\d\)\s+/.test(p)).slice(0, 3);

      if (items.length === 0) {
        return {
          title: "3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO",
          items: [{ n: 1, name: "Resposta", meta: "", body: raw }]
        };
      }

      const cards = items.map((block) => {
        const m = block.match(/^(\d+)\)\s*([\s\S]*)$/);
        const n = m ? Number(m[1]) : 1;
        const content = (m ? m[2] : block).trim();
        const lines = content.split("\n").map(l => l.trim()).filter(Boolean);

        const name = lines[0] || `Recomenda√ß√£o ${n}`;

        let meta = "";
        for (const l of lines.slice(1, 6)) {
          if (/R\$|c[i√≠]trico|amadeir|gourmand|aqu[a√°]tico|floral|foug[e√™]re|oriental|arom[a√°]tico|frut/i.test(l)) {
            meta = l.replace(/^[-‚Ä¢]\s*/, "");
            break;
          }
        }

        let bodyLines = lines.slice(1);
        if (meta) bodyLines = bodyLines.filter(l => l.replace(/^[-‚Ä¢]\s*/, "") !== meta);
        const body = bodyLines.join("\n").trim();

        return { n, name, meta, body };
      });

      return { title: "3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO", items: cards };
    }

    function renderCards(parsed) {
      cardsEl.innerHTML = "";
      headerEl.style.display = "block";
      headerSubEl.textContent = "Baseado no seu diagn√≥stico e lacunas identificadas.";

      const frag = document.createDocumentFragment();

      parsed.items.forEach((it) => {
        const card = document.createElement("div");
        card.className = "recCard";
        card.innerHTML = `
          <div class="recTop">
            <div class="num">${it.n}</div>
            <div style="flex:1">
              <h3 class="recName">${escapeHtml(it.name)}</h3>
              <div class="meta">
                ${it.meta ? `<span class="pill">üí† ${escapeHtml(it.meta)}</span>` : `<span class="pill">‚úÖ Recomenda√ß√£o</span>`}
              </div>
            </div>
          </div>
          ${it.body ? `<div class="body">${beautifyBody(it.body)}</div>` : ""}
        `;
        frag.appendChild(card);
      });

      cardsEl.appendChild(frag);
      sendHeightToParent();
    }

    async function callApi(finalPrompt) {
      clearError();
      setStatus("Consultando o Perfumista‚Ä¶");
      notifyParent("loading", { value: true });

      try {
        sendBtn.disabled = true;

        const r = await fetch(ENDPOINT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: finalPrompt })
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(data?.error ? String(data.error) : ("HTTP " + r.status));

        const text = (data?.text || "").trim();
        if (!text) throw new Error("Resposta vazia da API.");

        const parsed = parseToCards(text);
        renderCards(parsed);

        setStatus("Pronto.");
        notifyParent("done", { value: true });

      } catch (e) {
        showError("Erro ao consultar o agente: " + String(e?.message || e));
        setStatus("Erro.");
        notifyParent("error", { message: String(e?.message || e) });

      } finally {
        sendBtn.disabled = false;
        notifyParent("loading", { value: false });
        sendHeightToParent();
      }
    }

    // clique "Gerar sugest√µes"
    sendBtn.addEventListener("click", async () => {
      const userText = (promptEl.value || "").trim();

      // se o usu√°rio n√£o digitar nada, mas tiver diagn√≥stico do mapa, usa s√≥ o diagn√≥stico
      let finalPrompt = "";
      if (!userText && DIAG_CONTEXT) {
        finalPrompt = DIAG_CONTEXT;
      } else if (userText && DIAG_CONTEXT) {
        // junta contexto + pedido novo (sem poluir textarea)
        finalPrompt =
          "DIAGN√ìSTICO (contexto):\n" + DIAG_CONTEXT +
          "\n\nPEDIDO (agora):\n" + userText;
      } else {
        finalPrompt = userText;
      }

      if (!finalPrompt.trim()) {
        setStatus("Digite sua situa√ß√£o ou use um diagn√≥stico do Mapa.");
        promptEl.focus();
        return;
      }

      await callApi(finalPrompt);

      // mant√©m textarea em branco depois de responder (pra incentivar novo pedido)
      promptEl.value = "";
      sendHeightToParent();
    });

    // ===== Receber comando do Mapa via iframe =====
    window.addEventListener("message", async (event) => {
      if (event.origin !== MAPA_ALLOWED_ORIGIN) return;

      const data = event.data || {};
      if (data.source !== "mapa" || data.type !== "set_and_run") return;

      const texto = (data.text || "").trim();
      if (!texto) return;

      // guarda como contexto e executa automaticamente, sem ‚Äúcolar‚Äù na caixa de digitar
      showContextBox(texto);
      await callApi(texto);

      // textarea fica em branco sempre
      promptEl.value = "";
      sendHeightToParent();
    });
  </script>
</body>
</html>
