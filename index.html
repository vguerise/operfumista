<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>O Perfumista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:#0b0b0c;
  color:white;
}
.container{
  max-width:900px;
  margin:auto;
  padding:24px;
}
h1{
  color:#d4af37;
  letter-spacing:3px;
  text-align:center;
}
.card{
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(212,175,55,.3);
  border-radius:16px;
  padding:20px;
  margin-top:20px;
}
textarea{
  width:100%;
  min-height:120px;
  background:#000;
  border:1px solid rgba(255,255,255,.2);
  color:white;
  padding:12px;
  border-radius:12px;
}
button{
  margin-top:10px;
  padding:12px 16px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.primary{
  background:#d4af37;
  color:black;
}
#status{
  margin-bottom:10px;
  opacity:.7;
}
.rec{
  border:1px solid rgba(255,255,255,.15);
  padding:12px;
  border-radius:12px;
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">
  <h1>O PERFUMISTA</h1>

  <div class="card">
    <div id="status">Pronto.</div>
    <div id="respostas"></div>

    <textarea id="prompt" placeholder="Quer mais alguma recomendação?"></textarea>
    <button class="primary" id="sendBtn">Gerar</button>
  </div>
</div>

<script>
const API_URL = "https://operfumista-api.vercel.app/api/perfumista";
const MAPA_ORIGIN = "https://vguerise.github.io";

let contextoMapa = "";

const statusEl = document.getElementById("status");
const respostasEl = document.getElementById("respostas");
const promptEl = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");

function setStatus(t){
  statusEl.textContent = t;
  enviarAltura();
}

function enviarAltura(){
  if(window.parent !== window){
    const h = document.body.scrollHeight;
    window.parent.postMessage({ source:"operfumista", type:"height", height:h }, MAPA_ORIGIN);
  }
}

async function chamarAPI(texto){
  setStatus("Consultando o Perfumista...");
  sendBtn.disabled = true;

  try{
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        prompt: texto
      })
    });

    const data = await resp.json();

    if(!resp.ok){
      throw new Error(data.error || "Erro HTTP " + resp.status);
    }

    renderizar(data);
    setStatus("Pronto.");

  }catch(err){
    respostasEl.innerHTML = `<div class="rec">Erro: ${err.message}</div>`;
    setStatus("Erro.");
  }

  sendBtn.disabled = false;
  enviarAltura();
}

function renderizar(data){
  respostasEl.innerHTML = "";

  if(Array.isArray(data.recomendacoes)){
    data.recomendacoes.forEach(r=>{
      const div = document.createElement("div");
      div.className="rec";
      div.innerHTML = `<b>${r.nome}</b><br>${r.por_que || ""}`;
      respostasEl.appendChild(div);
    });
  }else{
    respostasEl.innerHTML = `<div class="rec">${JSON.stringify(data)}</div>`;
  }
}

sendBtn.onclick = ()=>{
  const texto = promptEl.value.trim();
  if(!texto) return;
  const final = contextoMapa ? contextoMapa + "\n\n" + texto : texto;
  chamarAPI(final);
  promptEl.value="";
};

window.addEventListener("message", e=>{
  if(e.origin !== MAPA_ORIGIN) return;

  if(e.data?.source==="mapa" && e.data.type==="set_and_run"){
    contextoMapa = e.data.text || "";
    if(contextoMapa) chamarAPI(contextoMapa);
  }
});

window.onload = enviarAltura;
</script>
</body>
</html>
