<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motor do Mapa ‚Äì Perfumista</title>
<style>
body{margin:0;font-family:Inter,system-ui;background:#2f2f2f;color:#eee}
.container{padding:16px}
.card{border:2px solid #d4b24c;border-radius:14px;padding:16px;background:linear-gradient(180deg,#5a5546,#3b382f)}
.h1{color:#d4b24c;font-weight:700;font-size:20px;text-align:center}
.sub{color:#bfbfbf;text-align:center;margin-bottom:12px}
.item{background:#2a2924;border-radius:12px;padding:12px;margin:10px 0;border-left:4px solid #d4b24c}
.item h3{margin:0;color:#d4b24c;font-size:16px}
.chat{margin-top:12px}
textarea{width:100%;min-height:60px;border-radius:8px;border:none;padding:8px}
button{margin-top:6px;width:100%;padding:10px;border:none;border-radius:8px;background:#d4b24c;color:#2f2f2f;font-weight:700}
</style>
</head>
<body>
<div class="container">
  <div id="results" class="card">
    <div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
    <div class="sub">Aguardando dados do mapa...</div>
  </div>

  <div class="chat">
    <textarea id="extra" placeholder="Precisa pedir algo a mais para a IA?"></textarea>
    <button onclick="sendExtra()">Enviar ao Perfumista</button>
  </div>
</div>

<script>
let basePrompt = null;

window.addEventListener('message', async (e)=>{
  if(!e.data || e.data.type!=='MAPA_DADOS') return;
  basePrompt = e.data.payload;
  await consultarAgente(basePrompt, null);
});

async function consultarAgente(prompt, extra){
  const res = document.getElementById('results');
  res.innerHTML = '<div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div><div class="sub">Consultando Perfumista...</div>';

  const body = extra ? {prompt, extra} : {prompt};

  try{
    const r = await fetch('/api/perfumista',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    const j = await r.json();
    render(j.text || j.top3 || j);

    // avisa o mapa pai para fechar o popup
    try{
      window.parent.postMessage({source:'perfumista_iframe', type:'IA_DONE'}, '*');
    }catch(e){}
  }catch(err){
    res.innerHTML = '<div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div><div class="sub">Erro ao consultar. Tente novamente.</div>';
    try{
      window.parent.postMessage({source:'perfumista_iframe', type:'IA_ERROR'}, '*');
    }catch(e){}
  }
}


function render(text){
  const lines = Array.isArray(text)?text:text.split(/\n+/).filter(l=>l.trim());
  const res = document.getElementById('results');
  res.innerHTML = '<div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div><div class="sub">Baseado no seu clima, or√ßamento e lacunas identificadas</div>';
  lines.slice(0,3).forEach((l,i)=>{
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML = `<h3>${i+1}. ${l}</h3>`;
    res.appendChild(div);
  });
}

function sendExtra(){
  if(!basePrompt) return;
  const extra = document.getElementById('extra').value;
  consultarAgente(basePrompt, extra);
}
</script>
</body>
</html>
