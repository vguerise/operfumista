<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>O Perfumista (Motor)</title>
<style>
:root{ --gold:#d4af37; --bg:#0b0b0c; --stroke:rgba(212,175,55,.22); --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.68); }
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
.wrap{padding:10px;}
textarea{width:100%;min-height:76px;max-height:170px;resize:vertical;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);padding:10px;outline:none;}
textarea::placeholder{color:rgba(255,255,255,.45);}
button{margin-top:8px;width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(212,175,55,.35);background:rgba(0,0,0,.25);color:var(--gold);font-weight:900;cursor:pointer;}
#status{margin-top:8px;font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">
  <textarea id="prompt" placeholder="Descreva o que você quer (ex.: 'quero fechar lacunas da coleção para trabalho em clima quente')"></textarea>
  <button id="btn">Gerar</button>
  <div id="status"></div>
</div>

<script>
const API = 'https://operfumista-api.vercel.app/api/perfumista';
const WARMUP_URL = 'https://operfumista-api.vercel.app/api/warmup';

// recebe comandos do mapa (opção B)
window.addEventListener('message', (event) => {
  const d = event.data || {};
  if (d && d.source === 'mapa' && d.type === 'run') {
    const p = String(d.prompt || '');
    const ta = document.getElementById('prompt');
    if (ta) ta.value = p;
    const btn = document.getElementById('btn');
    if (btn) btn.click();
  }
});
const MAPA_ORIGIN = 'https://vguerise.github.io';

function sendHeight(){
  try {
    const h = Math.max(document.documentElement.scrollHeight||0, document.body.scrollHeight||0);
    window.parent.postMessage({ source:'operfumista', type:'resize', height:h }, MAPA_ORIGIN);
  } catch(e){}
}

window.addEventListener('load', () => setTimeout(sendHeight, 40));
window.addEventListener('resize', () => setTimeout(sendHeight, 40));

async function warmup(){
  try { await fetch(WARMUP_URL, { method:'GET', mode:'cors' }); } catch(e){}
}

function safeJSON(x){ return (x && typeof x === 'object') ? x : {}; }

function pickPayload(data){
  const d = safeJSON(data);
  // Aceita tanto o formato novo (snake_case) quanto alias antigos
  const diagnostico = d.diagnostico || d.analise || d.diagnostico_colecao || null;
  const familias_percentuais = d.familias_percentuais || d.familias || null;
  const recomendacoes = Array.isArray(d.recomendacoes) ? d.recomendacoes : [];
  return { diagnostico, familias_percentuais, recomendacoes, raw: d };
}


window.addEventListener('message', async (event) => {
  const d = event.data || {};
  if (!d || d.source !== 'mapa' || d.type !== 'run') return;
  const p = (d.prompt || '').toString();
  if (p) {
    document.getElementById('prompt').value = p;
  }
  if (d.auto) {
    document.getElementById('btn').click();
  } else {
    sendHeight();
  }
});

document.getElementById('btn').addEventListener('click', async () => {
  const status = document.getElementById('status');
  const prompt = (document.getElementById('prompt').value || '').trim();
  status.textContent = 'Consultando…';
  sendHeight();
  await warmup();

  try {
    const r = await fetch(API, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });

    const data = await r.json();
    const payload = pickPayload(data);

    // ✅ opção B: iframe só manda JSON; mapa renderiza
    window.parent.postMessage(
      { source:'operfumista', type:'analysis', payload },
      MAPA_ORIGIN
    );

    status.textContent = 'Pronto.';
  } catch (e) {
    status.textContent = 'Erro ao consultar a API.';
    try {
      window.parent.postMessage(
        { source:'operfumista', type:'analysis', payload: { diagnostico:null, familias_percentuais:null, recomendacoes:[], error:String(e) } },
        MAPA_ORIGIN
      );
    } catch(_) {}
  } finally {
    setTimeout(sendHeight, 60);
  }
});
</script>
</body>
</html>
