<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>O Perfumista</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --gold:#d4af37;
  --bg:#0b0b0c;
  --card:rgba(0,0,0,.32);
  --stroke:rgba(212,175,55,.18);
  --stroke2:rgba(212,175,55,.28);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.68);
}
body{
  margin:0;
  background:linear-gradient(#0b0b0c,#000);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  padding:28px;
}
.container{max-width:900px;margin:auto}
h1{text-align:center;color:var(--gold);letter-spacing:3px}
.card{
  background:var(--card);
  border:1px solid var(--stroke2);
  border-radius:18px;
  padding:20px;
}
.rec{
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}
.rec b{color:var(--gold)}
textarea{
  width:100%;
  min-height:120px;
  background:#000;
  color:white;
  border:1px solid rgba(255,255,255,.15);
  border-radius:12px;
  padding:12px;
  margin-top:12px;
}
button{
  margin-top:10px;
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:var(--gold);
  color:black;
  font-weight:700;
  cursor:pointer;
}
#status{opacity:.7;margin-bottom:10px}
</style>
</head>

<body>
<div class="container">
<h1>O PERFUMISTA</h1>

<div class="card">
  <div id="status">Pronto.</div>
  <div id="cards"></div>

  <textarea id="prompt" placeholder="Quer outra recomendação?"></textarea>
  <button id="sendBtn">Gerar</button>
</div>
</div>

<script>
const API = "https://operfumista-api.vercel.app/api/perfumista";
const MAPA_ORIGIN = "https://vguerise.github.io";

let contexto="";

const cards = document.getElementById("cards");
const status = document.getElementById("status");
const prompt = document.getElementById("prompt");
const btn = document.getElementById("sendBtn");

function setStatus(t){
  status.textContent=t;
  resize();
}

function resize(){
  if(window.parent!==window){
    window.parent.postMessage({source:"operfumista",type:"height",height:document.body.scrollHeight},MAPA_ORIGIN);
  }
}

async function callAI(text){
  if(!text.trim()) return;
  setStatus("Consultando o Perfumista…");
  try{
    const r = await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({diagnostico:text,prompt:text})
    });
    const data = await r.json();
    if(!r.ok) throw new Error(data.error||"Erro");
    render(data);
    setStatus("Pronto.");
  }catch(e){
    cards.innerHTML=`<div class="rec">Erro: ${e.message}</div>`;
    setStatus("Erro.");
  }
  resize();
}

function render(data){
  cards.innerHTML="";
  data.recomendacoes.forEach(r=>{
    const d=document.createElement("div");
    d.className="rec";
    d.innerHTML=`<b>${r.nome}</b><ul>
      <li>${r.por_que}</li>
      <li>${r.quando_usar}</li>
      <li>${r.familia} • ${r.faixa_preco}</li>
    </ul>`;
    cards.appendChild(d);
  });
}

btn.onclick=()=>{
  const t = contexto? contexto+"\n"+prompt.value:prompt.value;
  callAI(t);
  prompt.value="";
};

window.addEventListener("message",e=>{
  if(e.origin!==MAPA_ORIGIN) return;
  if(e.data?.source==="mapa"){
    contexto=e.data.text||"";
    callAI(contexto);
  }
});

window.onload=resize;
</script>
</body>
</html>
