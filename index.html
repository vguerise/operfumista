<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Motor do Mapa ‚Äì Perfumista (v6)</title>
<style>
  body{margin:0;font-family:Inter,system-ui;background:#2f2f2f;color:#eee}
  .container{padding:16px}
  .card{border:2px solid #d4b24c;border-radius:14px;padding:16px;background:linear-gradient(180deg,#5a5546,#3b382f)}
  .h1{color:#d4b24c;font-weight:800;font-size:20px;text-align:center;letter-spacing:0.2px}
  .sub{color:#bfbfbf;text-align:center;margin:10px 0 12px}
  .item{background:#2a2924;border-radius:12px;padding:12px;margin:10px 0;border-left:4px solid #d4b24c}
  .item h3{margin:0;color:#d4b24c;font-size:16px;line-height:1.25}
  .hint{color:#cfcfcf;font-size:0.92em;line-height:1.35;margin-top:10px}
  .chat{margin-top:12px}
  textarea{width:100%;min-height:60px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);background:rgba(255,255,255,0.06);color:#fff;padding:10px;outline:none}
  button{margin-top:8px;width:100%;padding:11px;border:none;border-radius:10px;background:#d4b24c;color:#2f2f2f;font-weight:900;cursor:pointer}
  .error{margin-top:10px;padding:10px;border-radius:10px;border:1px solid rgba(255,120,120,0.5);background:rgba(255,80,80,0.12);color:#ffd3d3}
  .small{color:#bfbfbf;font-size:0.85em;margin-top:8px;word-break:break-word}
</style>
</head>
<body>
<div class="container">
  <div id="results" class="card">
    <div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
    <div class="sub">Motor carregado. Aguardando dados do mapa‚Ä¶</div>
    <div class="hint">Assim que voc√™ clicar em <strong>Mapear Cole√ß√£o!</strong>, o Top 3 aparece aqui.</div>
    <div class="small">Endpoint: https://operfumista-api.vercel.app/api/perfumista</div>
    <div class="small" id="dbg">Status: pronto (IFRAME_READY enviado)</div>
  </div>

  <div class="chat">
    <textarea id="extra" placeholder="Precisa pedir algo a mais para a IA? (ex.: sem baunilha, mais noturno, etc.)"></textarea>
    <button id="btnExtra" type="button">Enviar ao Perfumista</button>
  </div>
</div>

<script>
  const API_URL = "https://operfumista-api.vercel.app/api/perfumista";
  const results = document.getElementById("results");
  const btnExtra = document.getElementById("btnExtra");

  function setDbg(msg){
    const el = document.getElementById("dbg");
    if(el) el.textContent = msg;
  }

  let basePrompt = null;

  // Handshake: avisa o pai que o iframe est√° pronto
  try {
    window.parent.postMessage({ type:"IFRAME_READY", ts: Date.now() }, "*");
  } catch(e) {}

  window.addEventListener("message", async (e) => {
    if(!e.data) return;

    if(e.data.type === "PING") {
      try { window.parent.postMessage({ type:"PONG", ts: Date.now() }, "*"); } catch(err) {}
      return;
    }

    if(e.data.type !== "MAPA_DADOS") return;

    basePrompt = e.data.payload;
    setDbg("Status: MAPA_DADOS recebido (iniciando POST)");

    // ACK para o pai (provar que recebeu)
    try { window.parent.postMessage({ type:"IFRAME_ACK", ts: Date.now() }, "*"); } catch(err) {}

    await consultarAgente(basePrompt, null);
  });

  btnExtra.addEventListener("click", () => {
    if(!basePrompt) {
      setDbg("Status: sem dados do mapa ainda (clique em Mapear Cole√ß√£o!)");
      return;
    }
    const extra = document.getElementById("extra").value.trim();
    consultarAgente(basePrompt, extra || null);
  });

  async function consultarAgente(prompt, extra){
    renderLoading();
    try{
      const body = extra ? { prompt, extra } : { prompt };
      const r = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      if(!r.ok){
        const t = await r.text();
        renderError("Falha ao consultar o Perfumista (" + r.status + ").", t);
        notifyDone(false);
        return;
      }

      const j = await r.json();
      const text = j.text || (Array.isArray(j.top3) ? j.top3.join("\n") : "") || "";
      renderTop3(text);
      notifyDone(true);
    }catch(err){
      renderError("Erro ao consultar o Perfumista.", String(err && err.message ? err.message : err));
      notifyDone(false);
    }
  }

  function renderLoading(){
    results.innerHTML = `
      <div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
      <div class="sub">Consultando Perfumista‚Ä¶</div>
      <div class="hint">Aguarde ‚Äî estou calculando o Top 3.</div>
      <div class="small">Endpoint: ${API_URL}</div>
      <div class="small" id="dbg">Status: POST em andamento‚Ä¶</div>
    `;
  }

  function normalizeLines(text){
    const raw = String(text||"")
      .replace(/\r/g,"")
      .split("\n")
      .map(l => l.trim())
      .filter(Boolean);

    const cleaned = raw
      .map(l => l.replace(/^[-‚Ä¢*\d\)\.\s]+/,"").trim())
      .filter(Boolean);

    return cleaned.slice(0,3);
  }

  function renderTop3(text){
    const lines = normalizeLines(text);
    results.innerHTML = `
      <div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
      <div class="sub">Baseado no seu clima, or√ßamento e lacunas identificadas</div>
      <div class="small">Endpoint: ${API_URL}</div>
      <div class="small" id="dbg">Status: Top 3 renderizado (IA_DONE enviado)</div>
    `;

    if(!lines.length){
      results.innerHTML += `<div class="error">N√£o recebi recomenda√ß√µes v√°lidas. Tente novamente.</div>`;
      return;
    }

    lines.forEach((l,i)=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<h3>${i+1}. ${escapeHtml(l)}</h3>`;
      results.appendChild(div);
    });
  }

  function renderError(title, detail){
    results.innerHTML = `
      <div class="h1">üéÅ 3 RECOMENDA√á√ïES PARA EQUILIBRAR SUA COLE√á√ÉO</div>
      <div class="sub">N√£o consegui gerar o Top 3</div>
      <div class="small">Endpoint: ${API_URL}</div>
      <div class="error"><strong>${escapeHtml(title)}</strong><br/>${escapeHtml(detail||"")}</div>
      <div class="small" id="dbg">Status: erro (IA_DONE enviado)</div>
    `;
  }

  function notifyDone(ok){
    try {
      window.parent.postMessage({ type:"IA_DONE", ok: !!ok, ts: Date.now() }, "*");
    } catch(e) {}
  }

  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
</script>
</body>
</html>
